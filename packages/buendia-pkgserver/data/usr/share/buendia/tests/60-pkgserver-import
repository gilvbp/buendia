test_10_pkgserver_import_bundle () {
    # Get the latest buendia-utils package
    apt-get download buendia-utils

    # Make a fancy new package with the version epoch bumped
    orig_deb=$(ls buendia-utils_*.deb | tail -1)
    deb=$(echo $orig_deb | sed -e 's/buendia-utils_/buendia-utils_2:/g')
    mv $orig_deb $deb

    # Extract the control files
    ar x $deb control.tar.gz
    mkdir ctrl; cd ctrl
    tar xfz ../control.tar.gz 

    # Bump the version to epoch 2
    sed -i -e 's/Version: /Version: 2:/' control
    
    # Rebuild the Debian package
    tar cfz ../control.tar.gz *
    cd ..
    ar r $deb control.tar.gz

    # Make a buendia bundle with the package included
    zip projectbuendia-all-10.zip $deb

    # Put the file on the "USB stick"
    mount_loopback
    mv projectbuendia-all-10.zip loop

    # Run the bundle import
    # TODO: The attempt to mount and import from loop0 succeeed, but then the
    # cron "script" fails with:
    #
    # ++ buendia-log buendia-pkgserver-import /dev/loop1
    # 2019-08-26 16:43:05 22512> (start) buendia-pkgserver-import /dev/loop1
    # 2019-08-26 16:43:05 22512> /dev/loop1 is a block device; mounting...
    # 2019-08-26 16:43:05 22512> mount: /dev/loop1: can't read superblock
    # 2019-08-26 16:43:05 22512> (end, status 32)
    # 
    # which arguably isn't an error
    execute_cron_right_now pkgserver || true
}

test_20_pkgserver_serves_the_deb () {
    deb=$(ls buendia-utils_*.deb | tail -1)
    local_hash=$(cat $deb | md5sum -)
    pkgserver_hash=$(curl -s http://localhost:9001/stable/${deb} | md5sum -)
    [ "$local_hash" = "$pkgserver_hash" ]
}

test_30_pkgserver_has_packages_list () {
    deb=$(ls buendia-utils_*.deb | tail -1)
    curl -f http://localhost:9001/dists/stable/main/binary-all/Packages > packages
    grep $deb packages
}

test_40_pkgserver_has_release_file () {
    curl -f http://localhost:9001/dists/stable/Release > release
    [ -s release ]
}

test_50_cleanup_pkgserver_repo () {
    deb=$(ls buendia-utils_*.deb | tail -1)
    rm /usr/share/buendia/packages/stable/$deb
    buendia-pkgserver-index-debs /usr/share/buendia/packages stable
    ! grep -q $deb /usr/share/buendia/packages/dists/stable/main/binary-all/Packages
}
